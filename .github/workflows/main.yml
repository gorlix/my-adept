name: Build and Release Adept Firmware

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write  # Required to create Releases

jobs:
  build:
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli

    steps:
    - name: Checkout QMK Firmware
      uses: actions/checkout@v4
      with:
        repository: qmk/qmk_firmware
        submodules: recursive
        path: qmk_firmware

    - name: Checkout User Keymap
      uses: actions/checkout@v4
      with:
        path: user_keymap

    - name: Setup Keymap
      run: |
        # 1. Create the destination directory for Ploopy Adept (Madromys)
        mkdir -p qmk_firmware/keyboards/ploopyco/madromys/keymaps/gorlix
        
        # 2. Find where the keymap files are located in your repo
        # This searches for 'keymap.c' inside the 'user_keymap' folder
        SRC_DIR=$(find user_keymap -name "keymap.c" -exec dirname {} \; | head -n 1)
        
        echo "Found keymap source files in: $SRC_DIR"
        
        # 3. Copy the files dynamically from the found directory
        cp "$SRC_DIR/config.h" qmk_firmware/keyboards/ploopyco/madromys/keymaps/gorlix/
        cp "$SRC_DIR/keymap.c" qmk_firmware/keyboards/ploopyco/madromys/keymaps/gorlix/
        cp "$SRC_DIR/rules.mk" qmk_firmware/keyboards/ploopyco/madromys/keymaps/gorlix/

    - name: Compile Firmware
      working-directory: qmk_firmware
      run: |
        # Compile for Ploopy Madromys (Adept)
        qmk compile -kb ploopyco/madromys -km gorlix
        
        # Find and rename the output file (usually ends in .uf2 for RP2040)
        find . -name "*.uf2" -exec mv {} ploopy_adept_gorlix.uf2 \;

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ploopy_adept_firmware
        path: qmk_firmware/ploopy_adept_gorlix.uf2
        if-no-files-found: error

    - name: Publish Release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      with:
        tag_name: latest
        name: Latest Firmware Build
        draft: false
        prerelease: false
        files: qmk_firmware/ploopy_adept_gorlix.uf2
        overwrite: true
