name: Build and Release Adept Firmware

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write  # Required to create Releases

jobs:
  build:
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli

    steps:
    - name: Checkout QMK Firmware
      uses: actions/checkout@v4
      with:
        repository: qmk/qmk_firmware
        submodules: recursive
        path: qmk_firmware

    - name: Checkout User Keymap
      uses: actions/checkout@v4
      with:
        path: user_keymap

    - name: Setup Keymap
      run: |
        # Create the keymap directory for Ploopy Adept (Madromys)
        mkdir -p qmk_firmware/keyboards/ploopyco/madromys/keymaps/gorlix
        
        # Copy your files into the QMK directory
        # Adjust paths if your files are in a subfolder in your repo
        cp user_keymap/gorlix/my-adept/my-adept-bf66eb7de804bf9f4e266e256554c8f682116623/config.h qmk_firmware/keyboards/ploopyco/madromys/keymaps/gorlix/
        cp user_keymap/gorlix/my-adept/my-adept-bf66eb7de804bf9f4e266e256554c8f682116623/keymap.c qmk_firmware/keyboards/ploopyco/madromys/keymaps/gorlix/
        cp user_keymap/gorlix/my-adept/my-adept-bf66eb7de804bf9f4e266e256554c8f682116623/rules.mk qmk_firmware/keyboards/ploopyco/madromys/keymaps/gorlix/

    - name: Compile Firmware
      working-directory: qmk_firmware
      run: |
        # Compile for Ploopy Madromys (Adept)
        qmk compile -kb ploopyco/madromys -km gorlix
        
        # Move the output file to a predictable name for the release
        # The find command ensures we get the file even if QMK names it differently
        find . -name "*.uf2" -exec mv {} ploopy_adept_gorlix.uf2 \;

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ploopy_adept_firmware
        path: qmk_firmware/ploopy_adept_gorlix.uf2
        if-no-files-found: error

    - name: Publish Release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      with:
        tag_name: latest
        name: Latest Firmware Build
        draft: false
        prerelease: false
        files: qmk_firmware/ploopy_adept_gorlix.uf2
        overwrite: true
