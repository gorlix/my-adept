name: Build and Release Adept Firmware

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write  # Necessario per creare la Release

jobs:
  build:
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli

    steps:
    - name: Checkout QMK Firmware
      uses: actions/checkout@v4
      with:
        repository: qmk/qmk_firmware
        submodules: recursive
        path: qmk_firmware

    - name: Checkout User Keymap
      uses: actions/checkout@v4
      with:
        path: user_keymap

    - name: Setup Keymap
      run: |
        # 1. Crea la cartella di destinazione per Ploopy Adept (Madromys)
        mkdir -p qmk_firmware/keyboards/ploopyco/madromys/keymaps/gorlix
        
        # 2. Trova dove sono i file keymap nel tuo repo (cerca keymap.c ovunque sia)
        SRC_DIR=$(find user_keymap -name "keymap.c" -exec dirname {} \; | head -n 1)
        
        echo "Found keymap source files in: $SRC_DIR"
        
        # 3. Copia i file dalla cartella trovata a quella di QMK
        cp "$SRC_DIR/config.h" qmk_firmware/keyboards/ploopyco/madromys/keymaps/gorlix/
        cp "$SRC_DIR/keymap.c" qmk_firmware/keyboards/ploopyco/madromys/keymaps/gorlix/
        cp "$SRC_DIR/rules.mk" qmk_firmware/keyboards/ploopyco/madromys/keymaps/gorlix/

    - name: Compile Firmware
      working-directory: qmk_firmware
      run: |
        # Compila per Ploopy Madromys (il nome in codice dell'Adept)
        qmk compile -kb ploopyco/madromys -km gorlix
        
        # Trova il file .uf2 compilato e rinominalo per la release
        find . -name "*.uf2" -exec mv {} ploopy_adept_gorlix.uf2 \;

    - name: Publish Release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      with:
        tag_name: latest
        name: Latest Firmware Build
        draft: false
        prerelease: false
        files: qmk_firmware/ploopy_adept_gorlix.uf2
